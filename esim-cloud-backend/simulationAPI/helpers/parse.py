import re
import json
import sys


def extract_data_from_ngspice_output(pathToFile):

    """ Parses the output file generated by ngspice and
    returns a json containing points to plot graph.
    """

    try:
        with open(pathToFile,'r') as f:
            f_contents = f.readlines()
            json_data = {"total_number_of_tables":0,"data":[]}
            curernt_headers = []
            total_number_of_tables = 0
        
            for line in f_contents:
                contents_of_line = line.split()

                if('Index' in contents_of_line):
                    line_set = remove_duplicate_items_from_list(contents_of_line)

                    if(line_set != curernt_headers):
                        curernt_headers = line_set
                        json_data["data"].append({"labels":[],"x":[],"y":[]})
                        index = len(json_data["data"]) - 1
                        for x in range(2,len(curernt_headers)):
                            json_data["data"][index]["y"].append([])
                        
                        for x in range(1,len(curernt_headers)):
                            json_data["data"][index]["labels"].append(curernt_headers[x])
                            total_number_of_tables += 1
                            
                else:
                    m = re.match('[0-9]+',line)
                    if(m):
                        d = (contents_of_line)
                        index = len(json_data["data"]) - 1
                        data = json_data["data"][index]
                        data["x"].append(contents_of_line[1])

                        for x in range(len(data["y"])):
                            data["y"][x].append(contents_of_line[x+2])


        json_data["total_number_of_tables"] = total_number_of_tables - len(json_data["data"])
        return json.dumps(json_data)

    except IOError as e:
        return "Cannot open file."


def remove_duplicate_items_from_list(line_list):
    res = []
    for i in line_list:
        if i not in res:
            res.append(i)
    return res


#for testing provide the filepath as command line argument
if __name__ == "__main__":
    
    filePath = sys.argv[1]
    print(extract_data_from_ngspice_output(filePath))
